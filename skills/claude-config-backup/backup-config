#!/bin/bash
# Claude Code Configuration Backup Script
# Usage: backup-config <backup_dir> [--exclude-skill <skill_name>]

set -e

BACKUP_DIR="${1:-.}"
EXCLUDE_SKILL=""
CLAUDE_DIR="$HOME/.claude"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --exclude-skill)
            EXCLUDE_SKILL="$2"
            shift 2
            ;;
        *)
            BACKUP_DIR="$1"
            shift
            ;;
    esac
done

# Expand ~ in path
BACKUP_DIR="${BACKUP_DIR/#\~/$HOME}"

echo "=== Claude Code Configuration Backup ==="
echo "Backup directory: $BACKUP_DIR"
echo ""

# Create backup directory
mkdir -p "$BACKUP_DIR"
mkdir -p "$BACKUP_DIR/plugins"
mkdir -p "$BACKUP_DIR/skills"
mkdir -p "$BACKUP_DIR/commands"

# Copy settings.json
if [ -f "$CLAUDE_DIR/settings.json" ]; then
    cp "$CLAUDE_DIR/settings.json" "$BACKUP_DIR/"
    echo "[OK] Copied settings.json"
else
    echo "[SKIP] settings.json not found"
fi

# Copy skills (excluding specified skill)
if [ -d "$CLAUDE_DIR/skills" ]; then
    for skill_dir in "$CLAUDE_DIR/skills"/*/; do
        skill_name=$(basename "$skill_dir")
        if [ "$skill_name" != "$EXCLUDE_SKILL" ]; then
            cp -r "$skill_dir" "$BACKUP_DIR/skills/"
            echo "[OK] Copied skill: $skill_name"
        else
            echo "[SKIP] Excluded skill: $skill_name"
        fi
    done
else
    echo "[SKIP] No skills directory found"
fi

# Copy commands
if [ -d "$CLAUDE_DIR/commands" ] && [ "$(ls -A "$CLAUDE_DIR/commands" 2>/dev/null)" ]; then
    cp -r "$CLAUDE_DIR/commands"/* "$BACKUP_DIR/commands/" 2>/dev/null || true
    echo "[OK] Copied commands"
else
    echo "[SKIP] No commands found"
fi

# Copy and clean plugin references
if [ -f "$CLAUDE_DIR/plugins/installed_plugins.json" ]; then
    # Copy and replace absolute paths with ~
    sed "s|$HOME|~|g" "$CLAUDE_DIR/plugins/installed_plugins.json" > "$BACKUP_DIR/plugins/installed_plugins.json"
    echo "[OK] Copied and cleaned installed_plugins.json"
fi

if [ -f "$CLAUDE_DIR/plugins/known_marketplaces.json" ]; then
    sed "s|$HOME|~|g" "$CLAUDE_DIR/plugins/known_marketplaces.json" > "$BACKUP_DIR/plugins/known_marketplaces.json"
    echo "[OK] Copied and cleaned known_marketplaces.json"
fi

# Remove any accidentally copied cache or marketplaces
rm -rf "$BACKUP_DIR/plugins/cache" 2>/dev/null || true
rm -rf "$BACKUP_DIR/plugins/marketplaces" 2>/dev/null || true

echo ""
echo "=== Backup Complete ==="
echo ""
echo "Files backed up to: $BACKUP_DIR"
echo ""
echo "To restore on another machine:"
echo "  mkdir -p ~/.claude"
echo "  cp settings.json ~/.claude/"
echo "  cp -r skills ~/.claude/"
echo "  cp -r commands ~/.claude/"
echo ""
echo "Then reinstall plugins in Claude Code with /plugin commands"
